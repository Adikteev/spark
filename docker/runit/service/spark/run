#!/bin/sh
set -e
set -x

exec 2>&1

export APPLICATION_WEB_PROXY_BASE="${DISPATCHER_UI_WEB_PROXY_BASE}"

cd /opt/spark/dist

HISTORY_SERVER_CONF=""
if [ "${ENABLE_HISTORY_SERVER:=false}" = "true" ]; then
    HISTORY_SERVER_CONF="spark.mesos.historyServer.url=${HISTORY_SERVER_WEB_PROXY_BASE}"
fi

sed "s,<WEBUI_URL>,${WEBUI_URL},;s,<HISTORY_SERVER_CONF>,${HISTORY_SERVER_CONF}," \
    conf/mesos-cluster-dispatcher.properties.template >conf/mesos-cluster-dispatcher.properties

exec /opt/spark/dist/bin/spark-class \
    org.apache.spark.deploy.mesos.MesosClusterDispatcher \
    --port "${DISPATCHER_PORT}" \
    --webui-port "${DISPATCHER_UI_PORT}" \
    --master "${MESOS_MASTER}" \
    --zk "${ZK}" \
    --host "${HOST}" \
    --name "${FRAMEWORK_NAME}" \
    --properties-file "conf/mesos-cluster-dispatcher.properties"

